name: SonyLIV Auto Update

on:
  schedule:
    - cron: '0 */2 * * *'   # Har 4 ghante mein auto-run
  workflow_dispatch:        # Manual run karne ke liye button

jobs:
  update-tokens:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Fetch hdnea (Bypass via Indian VPS)
        id: fetch_hdnea
        env:
          # Secrets ko environment variables mein map kiya gaya hai
          PROXY: ${{ secrets.SONY_PROXY }}
          API_URL: ${{ secrets.SONY_API_URL }}
        run: |
          echo "Connecting to Indian VPS Proxy..."
          # curl command jo secrets use karke token fetch karega
          RESPONSE=$(curl -s -L -x "$PROXY" \
            --connect-timeout 120 \
            --retry 5 \
            --retry-delay 10 \
            -H 'User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/129.0.0.0 Safari/537.36' \
            -H 'Referer: https://www.sonyliv.com/' \
            "$API_URL")

          if [ -z "$RESPONSE" ]; then
            echo "Error: Timeout or Empty Response. Check if VPS is running."
            exit 1
          fi

          # Response se Video URL aur hdnea token extract karna
          echo "$RESPONSE" > api_response.json
          VIDEO_URL=$(echo "$RESPONSE" | grep -o '"videoURL":"[^"]*' | cut -d'"' -f4 | head -1)
          HDNEA=$(echo "$VIDEO_URL" | grep -o 'hdnea=[^&" ]*' | head -1)

          if [ -z "$HDNEA" ]; then
            echo "Error: Token extraction failed. Response might be geo-blocked."
            exit 1
          fi

          echo "Success! Token found."
          # Token ko agle step ke liye output variable mein save karein
          echo "HDNEA=$HDNEA" >> $GITHUB_OUTPUT

      - name: Update s111.m3u
        run: |
          NEW_TOKEN="${{ steps.fetch_hdnea.outputs.HDNEA }}"
          # s111.m3u mein sabhi purane tokens ko naye token se replace karna
          sed -i "s|hdnea=[^&\"' ]*|${NEW_TOKEN}|g" s111.m3u
          echo "Updated s111.m3u successfully."

      - name: Commit and Push Changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add s111.m3u
          # Agar koi change nahi hai toh push skip karein
          git diff --quiet && git diff --staged --quiet || (git commit -m "Auto-update SonyLIV token" && git push)
